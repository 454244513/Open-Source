--[[
由Sukuna开源
Source by Sukuna
https://github.com/454244513/Open-Source/blob/main/%E4%BF%84%E4%BA%A5%E4%BF%84%E5%B7%9E%E6%8D%A2%E6%9C%8D%E6%8C%82%E6%9C%BA
]]
if not game:IsLoaded() then
	game.Loaded:Wait()
end

local Players = cloneref(game:GetService("Players"))
local HttpService = cloneref(game:GetService("HttpService"))
local TeleportService = cloneref(game:GetService("TeleportService"))
local ReplicatedStorage = cloneref(game:GetService("ReplicatedStorage"))
local LocalPlayer = Players.LocalPlayer
local Character
local HumanoidRootPart
local Humanoid

if not LocalPlayer.Character then
	LocalPlayer.CharacterAdded:Wait()
end
Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
Humanoid = Character:WaitForChild("Humanoid")

LocalPlayer.CharacterAdded:Connect(function(char)
	Character = char
	HumanoidRootPart = char:WaitForChild("HumanoidRootPart")
	Humanoid = char:WaitForChild("Humanoid")
end)

LocalPlayer.OnTeleport:Connect(function(state)
	queue_on_teleport([[
        if not game:IsLoaded() then game.Loaded:Wait() end
        local Players = cloneref(game:GetService("Players"))
        local LocalPlayer = Players.LocalPlayer
        local Character
        local HumanoidRootPart
        local Humanoid
        Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
        HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
        Humanoid = Character:WaitForChild("Humanoid")
        loadstring(game:HttpGet('https://raw.githubusercontent.com/454244513/Open-Source/refs/heads/main/%E4%BF%84%E4%BA%A5%E4%BF%84%E5%B7%9E%E6%8D%A2%E6%9C%8D%E6%8C%82%E6%9C%BA'))()
    ]])
end)

local function getServers()
	local url = "https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?limit=100"

	local success, response = pcall(function()
		return game:HttpGet(url)
	end)

	if success then
		if not response or response == "" then
			return
		end

		local success2, data = pcall(function()
			return HttpService:JSONDecode(response)
		end)

		if success2 then
			return data
		end
	end
end

local servers = getServers()
local Serverlist = {}
if servers and servers.data then
	for _, server in ipairs(servers.data) do
		if server.id ~= game.JobId and server.playing < server.maxPlayers then
			table.insert(Serverlist, server.id)
		end
	end
end

local itemdone = false
local ItemPickups = {}
local Permanent = {}
for _, des in ipairs(workspace.Game.Entities.ItemPickup:GetDescendants()) do
	if des:IsA("ProximityPrompt") then
		des.MaxActivationDistance = 0
		table.insert(ItemPickups, des)
	elseif des:IsA("ClickDetector") then
		table.insert(ItemPickups, des)
	end
end
workspace.Game.Entities.ItemPickup.DescendantAdded:Connect(function(des)
	if des:IsA("ProximityPrompt") then
		des.MaxActivationDistance = 0
		table.insert(ItemPickups, des)
	elseif des:IsA("ClickDetector") then
		table.insert(ItemPickups, des)
	end
end)

for _, folder in pairs({
	ReplicatedStorage.devv.shared.Indicies.v3items.bin.Holdable,
	ReplicatedStorage.devv.shared.Indicies.v3items.bin.Droppable,
	ReplicatedStorage.devv.shared.Indicies.v3items.bin.Melee,
}) do
	if folder then
		for _, child in pairs(folder:GetChildren()) do
			if child and child:IsA("ModuleScript") then
				local success, module = pcall(require, child)
				if success and module then
					if module.permanent and module.name then
						table.insert(Permanent, module.name)
					end
				end
			end
		end
	end
end

task.spawn(function()
	while task.wait() do
		if HumanoidRootPart and Humanoid then
			local foundPermanent = false
			for i, v in pairs(ItemPickups) do
				if v and v.Parent and v:IsA("ProximityPrompt") and v.ObjectText then
					if table.find(Permanent, v.ObjectText) then
						foundPermanent = true
						pcall(function()
							HumanoidRootPart.CFrame = v.Parent.CFrame
							fireproximityprompt(v)
							Humanoid:MoveTo(HumanoidRootPart.Position + Vector3.new(10, 0, 0))
						end)
					end
				end
			end
			if not foundPermanent then
				itemdone = true
			end
		end
	end
end)

--[[
	repeat
		task.wait()
		pcall(function()
			HumanoidRootPart.CFrame = workspace.BankRobbery.BankCash.Main.CFrame * CFrame.new(0, 5, 0)
			fireproximityprompt(workspace.BankRobbery.BankCash.Main.Attachment.ProximityPrompt)
		end)
	until LocalPlayer:GetAttribute("bankCash") == 0
]]

local otimer = os.time()
local timer = otimer
while task.wait(0.1) do
	timer = os.time()
	if (itemdone or timer >= (getgenv().maxwaittime and getgenv().maxwaittime)) and #Serverlist > 0 then
		local targetServer = Serverlist[math.random(1, #Serverlist)]
		TeleportService:TeleportToPlaceInstance(game.PlaceId, targetServer)
		break
	end
end
